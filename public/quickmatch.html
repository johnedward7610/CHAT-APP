<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quick Match</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#BCC0E8; margin:0; padding:0;}
  .container { max-width:500px; margin:50px auto; background:white; padding:20px; border-radius:20px;}
  #countdown { font-size:24px; margin:20px 0;}
  #chatArea { display:none; margin-top:20px; }
  #messages { height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px; margin-bottom:10px; }
  input, button { padding:10px; width:80%; margin:5px 0; }
</style>
</head>
<body><div class="container">
  <h2>Quick Match</h2>
  <p id="status">Searching for a match...</p>
  <div id="countdown"></div>
  <div id="chatArea">
    <div id="messages"></div>
    <input id="msgInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <br>
    <button id="likeBtn">Like</button>
  </div>
</div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { 
  getFirestore, collection, doc, setDoc, deleteDoc, serverTimestamp,
  onSnapshot, query, where, limit, getDocs, runTransaction 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// ðŸ”¥ Your Firebase Config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let chatId = null;
let countdownInterval = null;

// Queue & Match
onAuthStateChanged(auth, user => {
  if(!user) { window.location.href = "/index.html"; return; }
  currentUser = user;
  joinQueue();
});

async function joinQueue() {
  const queueRef = doc(db, "quickchat_queue", currentUser.uid);
  await setDoc(queueRef, { uid: currentUser.uid, timestamp: serverTimestamp() });

  const q = query(collection(db, "quickchat_queue"), where("uid", "!=", currentUser.uid));
  const unsubscribe = onSnapshot(q, async snap => {
    if(snap.empty) return; // no one to match
    const randomUserDoc = snap.docs[Math.floor(Math.random() * snap.docs.length)];
    const randomUser = randomUserDoc.data();

    // Transaction to create chat safely
    await runTransaction(db, async (transaction) => {
      const otherQueueRef = doc(db, "quickchat_queue", randomUser.uid);
      const selfQueueRef = doc(db, "quickchat_queue", currentUser.uid);
      const otherSnap = await transaction.get(otherQueueRef);
      if(!otherSnap.exists()) return; // already matched

      // create chat
      const chatRef = doc(collection(db, "quickchats"));
      transaction.set(chatRef, {
        users: [currentUser.uid, randomUser.uid],
        startedAt: serverTimestamp(),
        likes: {}
      });
      transaction.delete(otherQueueRef);
      transaction.delete(selfQueueRef);
      chatId = chatRef.id;
    });

    if(chatId) {
      startChat(randomUser.uid);
      unsubscribe(); // stop listening to queue
    }
  });
}

// Start Chat & Countdown
function startChat(otherUid) {
  document.getElementById("status").innerText = "Match found!";
  const chatArea = document.getElementById("chatArea");
  chatArea.style.display = "block";

  let timeLeft = 60;
  const countdownEl = document.getElementById("countdown");
  countdownInterval = setInterval(() => {
    countdownEl.innerText = "Time left: " + timeLeft + "s";
    timeLeft--;
    if(timeLeft < 0) {
      clearInterval(countdownInterval);
      endChat(false); // time over
    }
  }, 1000);

  // Listen to chat messages
  const messagesEl = document.getElementById("messages");
  const chatRef = doc(db, "quickchats", chatId);
  onSnapshot(chatRef, snap => {
    if(!snap.exists()) return;
    const data = snap.data();
    if(data.messages) {
      messagesEl.innerHTML = "";
      data.messages.forEach(m => {
        const div = document.createElement("div");
        div.innerText = (m.uid===currentUser.uid?"You":"Other")+": "+m.text;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  });

  // Send messages
  document.getElementById("sendBtn").onclick = async () => {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if(!text) return;
    await runTransaction(db, async t => {
      const cSnap = await t.get(chatRef);
      const data = cSnap.data();
      const messages = data.messages || [];
      messages.push({ uid: currentUser.uid, text, timestamp: serverTimestamp() });
      t.update(chatRef, { messages });
    });
    input.value = "";
  };

  // Like button
  document.getElementById("likeBtn").onclick = async () => {
    await runTransaction(db, async t => {
      const cSnap = await t.get(chatRef);
      const data = cSnap.data();
      const likes = data.likes || {};
      likes[currentUser.uid] = true;
      t.update(chatRef, { likes });
    });
  };
}

// End Chat
async function endChat(liked) {
  document.getElementById("status").innerText = "Chat ended!";
  document.getElementById("chatArea").style.display = "none";

  // You can handle storing the match result in a collection
  // e.g., matches/{chatId} = {users:[uid1,uid2], liked: {uid1:true,...} }

  chatId = null;
}

</script></body>
</html>
