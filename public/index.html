<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Global Messenger Chat</title>
<style>
body { margin:0; font-family: Arial; display:flex; justify-content:center; background:#e5e5e5;}
.chat-container { width:100%; max-width:450px; height:100vh; background:white; display:flex; flex-direction:column;}
.header { background:#0084ff; color:white; padding:15px; text-align:center; font-weight:bold;}
.messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px;}
.msg { max-width:75%; padding:10px 14px; border-radius:18px; font-size:15px; word-wrap:break-word;}
.sent { background:#0084ff; color:white; margin-left:auto; border-bottom-right-radius:4px;}
.received { background:#f1f0f0; color:black; margin-right:auto; border-bottom-left-radius:4px;}
.input-area { display:flex; padding:10px; gap:10px; background:#fafafa; border-top:1px solid #ddd;}
.input-area input { flex:1; padding:12px; border:1px solid #ccc; border-radius:20px; font-size:15px;}
.input-area button { background:#0084ff; border:none; padding:10px 16px; border-radius:20px; color:white; font-size:15px; cursor:pointer;}
</style>
</head>
<body><div class="chat-container">
  <div class="header">Global Messenger Chat</div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="messageInput" type="text" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

// ðŸ”¹ Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDXXQvWziaNYaStkNkDjDclNxrVa_7qYX8",
  authDomain: "chat-34ff3.firebaseapp.com",
  projectId: "chat-34ff3",
  storageBucket: "chat-34ff3.appspot.com",
  messagingSenderId: "391966829170",
  appId: "1:391966829170:web:2b9fa454e8be176b7930eb",
  measurementId: "G-81MNVPKD3W"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const messagesEl = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

let userId = "anon";

// ðŸ”¹ Local message storage
function saveLocal(text, sent){
  const msgs = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  msgs.push({ text, sent });
  localStorage.setItem("chatHistory", JSON.stringify(msgs));
}

function renderMessages(){
  messagesEl.innerHTML = "";
  const msgs = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  msgs.forEach(m => {
    const div = document.createElement("div");
    div.className = "msg " + (m.sent ? "sent":"received");
    div.textContent = m.text;
    messagesEl.appendChild(div);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// ðŸ”¹ Load messages from localStorage
renderMessages();

// ðŸ”¹ Anonymous login
signInAnonymously(auth)
  .then(res => { userId = res.user.uid; console.log("Signed in UID:", userId); })
  .catch(err => console.warn("Anonymous auth failed, using fallback UID:", err));

// ðŸ”¹ Firestore collection
const messagesRef = collection(db, "messages");
const q = query(messagesRef, orderBy("timestamp"));

// ðŸ”¹ Listen for new messages
onSnapshot(q, snapshot => {
  snapshot.docChanges().forEach(async change => {
    if(change.type === "added"){
      const msg = change.doc.data();
      const docId = change.doc.id;

      // Only process messages not from self
      if(msg.from !== userId){
        saveLocal(msg.text, false);
        renderMessages();

        // Delete the message from Firebase after saving locally
        try {
          await deleteDoc(doc(db, "messages", docId));
        } catch(e) { console.error("Delete failed:", e); }
      }
    }
  });
});

// ðŸ”¹ Send messages
sendBtn.addEventListener("click", async () => {
  const text = messageInput.value.trim();
  if(!text) return;
  messageInput.value = "";
  saveLocal(text, true);
  renderMessages();
  try{
    await addDoc(messagesRef, { text, from: userId, timestamp: serverTimestamp() });
  }catch(e){ console.error("Send failed:", e); }
});

// ðŸ”¹ Send with Enter key
messageInput.addEventListener("keydown", e => { if(e.key === "Enter") sendBtn.click(); });
</script></body>
</html>
