<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Messenger Firestore Chat</title>

<style>
  body {
    margin: 0;
    background: #e5e5e5;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
  }

  .chat-container {
    width: 100%;
    max-width: 450px;
    height: 100vh;
    background: white;
    display: flex;
    flex-direction: column;
  }

  .header {
    background: #0084ff;
    color: white;
    padding: 15px;
    font-size: 20px;
    text-align: center;
    font-weight: bold;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .msg {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.3;
    word-wrap: break-word;
  }

  .sent {
    background: #0084ff;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .received {
    background: #f1f0f0;
    color: black;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }

  .input-area {
    display: flex;
    padding: 10px;
    gap: 10px;
    background: #fafafa;
    border-top: 1px solid #ddd;
  }

  .input-area input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 15px;
  }

  .input-area button {
    background: #0084ff;
    border: none;
    padding: 10px 16px;
    border-radius: 20px;
    color: white;
    font-size: 15px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="chat-container">
  <div class="header">Messenger Firestore Chat</div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="messageInput" type="text" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  // ---------------- Firebase Config ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyDXXQvWziaNYaStkNkDjDclNxrVa_7qYX8",
    authDomain: "chat-34ff3.firebaseapp.com",
    projectId: "chat-34ff3",
    storageBucket: "chat-34ff3.firebasestorage.app",
    messagingSenderId: "391966829170",
    appId: "1:391966829170:web:2b9fa454e8be176b7930eb",
    measurementId: "G-81MNVPKD3W"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------------- LocalStorage & DOM ----------------
  const messagesEl = document.getElementById("messages");
  const sendBtn = document.getElementById("sendBtn");

  function saveLocal(text, sent) {
    let msgs = JSON.parse(localStorage.getItem("chatHistory") || "[]");
    msgs.push({ text, sent });
    localStorage.setItem("chatHistory", JSON.stringify(msgs));
  }

  function renderMessages() {
    messagesEl.innerHTML = "";
    let msgs = JSON.parse(localStorage.getItem("chatHistory") || "[]");
    msgs.forEach(m => {
      let div = document.createElement("div");
      div.className = "msg " + (m.sent ? "sent" : "received");
      div.textContent = m.text;
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  renderMessages();

  // ---------------- Chat ----------------
  let userId, chatPartner, chatId;

  signInAnonymously(auth).then(res => {
    userId = res.user.uid;
    console.log("Your User ID:", userId);

    chatPartner = prompt("Enter the other user's ID:", "user_xxxxx");
    if (!chatPartner) chatPartner = "user_xxxxx";

    // Chat ID = sorted combination of two users
    chatId = [userId, chatPartner].sort().join("_");

    const messagesRef = collection(db, "chats", chatId, "messages");
    const q = query(messagesRef, orderBy("timestamp"));

    // Listen for incoming messages
    onSnapshot(q, (snapshot) => {
      snapshot.docChanges().forEach(async (change) => {
        if (change.type === "added") {
          const msg = change.doc.data();
          if (msg.from !== userId) {
            saveLocal(msg.text, false);
            renderMessages();

            // Delete message after receiving
            await deleteDoc(doc(db, "chats", chatId, "messages", change.doc.id));
          }
        }
      });
    });

    // Send message button
    sendBtn.addEventListener("click", async () => {
      const input = document.getElementById("messageInput");
      if (!input.value.trim()) return;

      const text = input.value;
      input.value = "";

      saveLocal(text, true);
      renderMessages();

      await addDoc(messagesRef, {
        text,
        from: userId,
        to: chatPartner,
        timestamp: Date.now()
      });
    });
  });
</script>

</body>
</html>
