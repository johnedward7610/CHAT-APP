<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Matches</title>
<style>
  body{margin:0;padding:0;font-family:Arial,sans-serif;background:#BCC0E8;}
  .Header{width:100%;height:5rem;background-color:#BCC0E8;border-radius:0 0 20px 20px;display:flex;justify-content:center;align-items:center;}
  .body{width:90%;max-width:600px;margin:20px auto;background:#BCC0E8;padding:10px;border-radius:20px 20px 0 0;}
  .user-card{width:100%;background:white;border-radius:15px;padding:15px;margin-bottom:15px;display:flex;align-items:center;gap:15px;cursor:pointer;transition:0.2s;}
  .user-card:hover{background:#e9e9ff;}
  .avatar{width:50px;height:50px;background:#dcdcff;border-radius:50%;}
  .user-text{font-size:18px;}
</style>
</head>
<body>

<div class="Header">
  <h1>Your Matches</h1>
</div>

<div class="body" id="matchesContainer">
  <p style="text-align:center;color:white;">Loading matches...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDXXQvWziaNYaStkNkDjDclNxrVa_7qYX8",
  authDomain: "chat-34ff3.firebaseapp.com",
  projectId: "chat-34ff3",
  storageBucket: "chat-34ff3.appspot.com",
  messagingSenderId: "391966829170",
  appId: "1:391966829170:web:2b9fa454e8be176b7930eb",
  measurementId: "G-81MNVPKD3W"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const container = document.getElementById("matchesContainer");

onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href="/login.html"; return; }
  const uid = user.uid;
  await loadMatches(uid);
});

async function loadMatches(uid){
  container.innerHTML = "<p style='text-align:center;color:white;'>Loading matches...</p>";

  // fetch all matches where this user is involved
  const matchesSnap = await getDocs(collection(db,"matches"));
  const matchedUserIds = [];

  matchesSnap.forEach(doc=>{
    const data = doc.data();
    if(data.users && data.users.includes(uid)){
      data.users.forEach(u=>{
        if(u!==uid && !matchedUserIds.includes(u)) matchedUserIds.push(u);
      });
    }
  });

  container.innerHTML = "";
  if(matchedUserIds.length===0){
    container.innerHTML = "<p style='text-align:center;color:white;'>No matches yet.</p>";
    return;
  }

  // load each matched user's info
  for(const otherId of matchedUserIds){
    const userDoc = await getDoc(doc(db,"users",otherId));
    if(userDoc.exists()){
      const userData = userDoc.data();
      const el = document.createElement("div");
      el.classList.add("user-card");
      el.innerHTML = `
        <div class="avatar"></div>
        <div class="user-text">
          <b>${userData.username||"Unknown"}</b><br>
          <small>${userData.gender||"Unknown"}</small>
        </div>
      `;
      el.onclick = ()=>{ window.location.href="/chat.html?id="+otherId; };
      container.appendChild(el);
    }
  }
}
</script>

</body>
</html>
